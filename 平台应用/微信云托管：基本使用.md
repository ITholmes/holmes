# 微信云托管

确实是个好平台，部署个项目很简易，免去了很多运维上的事情。

**一、微信云托管 github 流水线配置 和 端口号**：

1. 首先，这里的**`主体(宿主机)`，指的就是你的代码本身**，可以理解为有一个服务器拉取了你的代码。
- 例如：Dockerfile文件中，指令：`COPY src /demo-server/src` 中的src目录，就是代码路径中的src目录。

2. **编写Dockerfile文件**（根据Dockerfile，创建镜像，启动容器）
- 例如：[如何写一个Dockerfile文件？](https://github.com/ITholmes/hello-world/blob/master/%E5%AD%A6%E8%AF%86%E6%AE%BF%E5%A0%82/Docker/Dockerfile%EF%BC%9A%E5%A6%82%E4%BD%95%E5%86%99%E4%B8%80%E4%B8%AADockerfile%E6%96%87%E4%BB%B6%EF%BC%9F.md)

```Dockerfile
# 选择构建用基础镜像。如需更换，请到[dockerhub官方仓库](https://hub.docker.com/_/java?tab=tags)自行选择后替换。
FROM maven:3.6.0-jdk-8-slim as build
# 指定构建过程中的工作目录
WORKDIR /demo-server
# 将src目录下所有文件，拷贝到工作目录中src目录下（.gitignore/.dockerignore中文件除外）
COPY src /demo-server/src
# 将pom.xml文件和settings.xml文件，拷贝到工作目录下
COPY settings.xml pom.xml /demo-server/
# 自定义settings.xml, 选用国内镜像源以提高下载速度
RUN mvn -s /demo-server/settings.xml -f /demo-server/pom.xml clean package

# 基础镜像
FROM  openjdk:8-jre
# 作者
MAINTAINER holmes
# 设置工作目录
WORKDIR /demo-server
# 复制jar包
COPY --from=build /demo-server/target/*.jar .
# 暴露端口
EXPOSE 80
# 启动程序
CMD ["java","-jar","demo-server-1.0-SNAPSHOT.jar"]
```

3. 明白项目，采用哪个端口号。
- **微信云托管-流水线配置、Dockerfile、服务配置都会有端口号，要明确配置的端口号是哪个**。
- **http 80 和 https 443 ，这两个协议默认的端口，大家都知道，但是也很容易忽略！**

> 🎈参考官方：https://github.com/WeixinCloud/wxcloudrun-springboot

**二、如何使用服务 基础信息-环境变量 ？**

在微信云托管中，通过配置环境变量，你可以向容器传递需要的配置信息。**这类似于在 Docker 中使用 -e 或 --env 选项来设置环境变量**。

微信云托管中的环境变量配置可能类似于以下 Docker 命令：

```powershell
docker run -e KEY1=value1 -e KEY2=value2 -e ANOTHER_KEY=another_value my_image
```

上述命令中，-e 选项用于设置容器中的环境变量，KEY1、KEY2 和 ANOTHER_KEY 是环境变量的名称，而 value1、value2 和 another_value 则是相应环境变量的值。

提醒一下，不同服务获取环境变量的语法不同，例如：

**SpringBoot 环境变量配置：**
- SpringBoot 环境变量替换格式为：${xxx}

![image](https://github.com/ITholmes/hello-world/assets/70437837/ba4658b5-c763-4c45-ba72-5c02b26c4cf8)

```yml
# 开发环境配置
spring:
  # 数据源配置
  datasource:
    type: com.alibaba.druid.pool.DruidDataSource
    driverClassName: com.mysql.cj.jdbc.Driver
    druid:
      # 主库数据源
      master:
        url: jdbc:mysql://${mysql_address}/holmes-center?useUnicode=true&characterEncoding=utf8&zeroDateTimeBehavior=convertToNull&useSSL=true&serverTimezone=GMT%2B8
        username: root
        password: ${mysql_address_password}
```

**Nginx 环境变量配置：**
- Nginx 环境变量替换格式为：$xxx


```nginx.conf
# 生产环境
location /prod-api/ {
  rewrite ^/prod-api(/.*)$ $1 break;
  # 根据 微信云托管环境变量 配置
  proxy_pass $SERVER_ADDRESS;
}
```





