# （运维）测试环境-集群搭建

## 一、k8s

搭建目标：

    --------------------------------------------
    k8s主节点node01：192.168.3.151
    k8s从节点node02：192.168.3.149
    rancher控制台：192.168.3.151
    --------------------------------------------
    中间件以及其它应用所在节点node03：192.168.3.150
    --------------------------------------------

### 1、检查yum源是否可用

在搞的时候，发现机器没有安装yum源，无法安装应用，我们需要先安装一个才可以，如果已经可以通过yum update升级软件，则说明yum是没有问题的，可以直接用，无需更换yum源。

    cd /etc/yum.repos.d
    wget -O /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-8.repo
    # 查看文件
    ls  
    # 清除所有文件
    yum -y clean all   
    # 建立缓存
    yum -y makecache   
    yum update

### 2、各节点准备工作-docker

安装所需的软件包。yum-utils 提供了 yum-config-manager ，并且 device mapper 存储驱动程序需要 device-mapper-persistent-data 和 lvm2。

    yum install -y yum-utils \
      device-mapper-persistent-data \
      lvm2

更新yum包

    yum update

添加docker源

    yum-config-manager \
        --add-repo \
        http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo

安装最新版本

    sudo yum install docker-ce docker-ce-cli containerd.io

或者安装指定版本

    # 查看docker版本列表
    yum list docker-ce --showduplicates | sort -r
    
    # 安装指定版本
    yum install docker-ce-<VERSION_STRING> docker-ce-cli-<VERSION_STRING> containerd.io
    yum install docker-ce-3:18.09.9-3.el7 docker-ce-cli-3:18.09.9-3.el7 containerd.io

停止/启动服务

    systemctl stop docker
    systemctl start docker
    
    # 配置镜像源
    cat >> /etc/docker/daemon.json << EOF
    {
      "registry-mirrors": ["https://b9pmyelo.mirror.aliyuncs.com"]
    }
    EOF
    
    # 重启docker
    systemctl restart docker

启动测试容器

    docker run hello-world

### 3、各节点准备工作-基本组件

    # 安装基础应用软件
    yum -y install conntrack ntpdate ntp ipvsadm ipset jq iptables curl sysstat libseccomp wget vim net-tools lsof
    
    cat >/etc/yum.repos.d/docker.repo<<EOF
    [docker-ce-edge]
    name=Docker CE Edge - \$basearch
    baseurl=https://mirrors.aliyun.com/docker-ce/linux/centos/7/\$basearch/edge
    enabled=1
    gpgcheck=1
    gpgkey=https://mirrors.aliyun.com/docker-ce/linux/centos/gpg
    EOF
    
    cat > /etc/yum.repos.d/kubernetes.repo << EOF
    [kubernetes]
    name=Kubernetes
    baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
    enabled=1
    gpgcheck=0
    repo_gpgcheck=0
    gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
    EOF
    
    # 关闭防火墙
    systemctl stop firewalld
    systemctl disable firewalld
    
    # 关闭selinux
    setenforce 0
    # 永久关闭
    sed -i 's/enforcing/disabled/' /etc/selinux/config
    
    # 关闭swap
    swapoff -a
    # 永久关闭
    sed -ri 's/.*swap.*/#&/' /etc/fstab
    
    # 安装kubelet、kubeadm、kubectl，同时指定版本
    yum install -y kubelet-1.20.10 kubeadm-1.20.10 kubectl-1.20.10

### 4、主节点初始化

    cat <<EOF | sudo tee /etc/modules-load.d/k8s.conf
    br_netfilter
    EOF
    
    cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf
    net.bridge.bridge-nf-call-ip6tables = 1
    net.bridge.bridge-nf-call-iptables = 1
    EOF
    sudo sysctl --system
    
    # 开启kubelet服务
    systemctl enable kubelet.service
    
    # bug修复：具体请看github官方issue：https://github.com/containerd/containerd/issues/4581
    rm -rf /etc/containerd/config.toml
    systemctl restart containerd
    
    # 可以提前下载一些镜像
    kubeadm config images pull
    
    # 初始化安装
    # 指定api-serverIP(本机IP)
    # 指定pod地址段
    # 指定服务地址段
    # 指定k8s版本
    # 指定镜像仓库（这里使用阿里云）
    kubeadm init --apiserver-advertise-address=192.168.3.151 --pod-network-cidr=10.244.0.0/16 --service-cidr=10.96.0.0/12 --kubernetes-version=v1.20.10 --image-repository=registry.aliyuncs.com/google_containers
    
    # 然后按照其最终提示执行命令，设置.kube，配置环境变量等

安装网络插件

    # 通过第三方网站查询到raw.githubusercontent.com所对应的ip是多少
    # http://ip.tool.chinaz.com/raw.githubusercontent.com
    # 查到的IP raw.githubusercontent.com
    
    vim /etc/hosts
    185.199.109.133  raw.githubusercontent.com
    
    # 然后：
    kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
    
    # 查看基础Pod：
    kubectl get pods -n kube-system
    # 查看k8s的集群节点
    kubectl get nodes
    # 检查集群状态
    curl -k https://localhost:6443/livez\?verbose
    curl -k https://localhost:6443/readyz\?verbose

### 5、从节点初始化

    kubeadm join 192.168.3.151:6443 --token hjhcyt.k7rphgmztmq1agbo \
        --discovery-token-ca-cert-hash sha256:85aa5e065cf2403b01915d79cb59d3be673891d4dce292b7fb4f9bdc1dbe797e

之后等一等，主节点会将网络相关pod在从节点上建立，两分钟后再看，就会发现所有节点都已经ready了

    kubectl get nodes -o wide

### 6、rancher控制台

主节点使用docker单机安装配置即可。

    docker run --name rancher --privileged -d -v /sypm/mount/rancher:/var/lib/rancher/ --restart=unless-stopped -p 80:80 -p 443:443 rancher/rancher:v2.5.14

通过http://192.168.3.151访问rancher，然后导入现有的k8s集群，根据其导入步骤在k8s集群主节点上执行即可（提示鉴权啥的则执行其给出的特殊命令即可）

然后等待个几分钟，刷新rancher页面，则会看到集群相关的信息

    # 注释端口号
    vim /etc/kubernetes/manifests/kube-controller-manager.yaml
    vim /etc/kubernetes/manifests/kube-scheduler.yaml
    
    # 重启kubelet服务
    service kubelet restart

刷新rancher页面，检查看看集群是否健康即可。

然后可能会显示集群不健康，我们需要改动一下配置：

    # 修改以上两个组件的静态pod的配置文件
    /etc/kubernetes/manifests/kube-controller-manager.yaml
    /etc/kubernetes/manifests/kube-scheduler.yaml
    # 两个文件，删除 --port=0
    
    # 重启kubelete
    service kubelet restart

## 二、必要应用

### 1、MySQL

    # 从官网下载配置文件到/sypm/mount/redis/conf/中
    mkdir -p /sypm/mount/mysql/mysql-3306/conf
    cd /sypm/mount/mysql/mysql-3306/conf
    
    # 上传&修改配置文件（如果没有，可以先不设置）
    # vim 
    
    docker run  -p 3306:3306 --name mysql-3306  --privileged=true  --restart unless-stopped -v /sypm/mount/mysql/mysql-3306/conf:/etc/mysql/conf.d -v /sypm/mount/mysql/mysql-3306/data:/var/lib/mysql -v /etc/localtime:/etc/localtime -e TZ=Asia/Shanghai -e MYSQL_ROOT_PASSWORD=XXXXX -d mysql:8.0.24

### 2、Redis

    # 从官网下载配置文件到/sypm/mount/redis/conf/中
    mkdir -p /sypm/mount/redis/redis-6379/conf
    cd /sypm/mount/redis/redis-6379/conf
    wget http://download.redis.io/redis-stable/redis.conf
    
    # 修改配置
    vim redis.conf
    
    # 运行
    docker run -p 6379:6379 --name redis-6379 --privileged=true --restart=always -v /sypm/mount/redis/redis-6379/data:/data -v /sypm/mount/redis/redis-6379/conf/redis.conf:/etc/redis/redis.conf -d redis:7.0.2 redis-server /etc/redis/redis.conf

### 3、MINIO

    docker run -p 9000:9000 -p 9090:9090 --name minio  -d --restart=always -e "MINIO_ROOT_USER=admin" -e "MINIO_ROOT_PASSWORD=md125SKeOcwqwF" -v /sypm/mount/minio/data:/data -v /sypm/mount/minio/.minio:/root/.minio minio/minio:RELEASE.2022-06-25T15-50-16Z server /data --address ':9000' --console-address ':9090'

然后访问：http://192.168.3.150:9090/buckets

之后可以新建一个桶，然后上传一张图片，之后share进行访问，看看是否可以访问成功。

### 4、Harbor

首先要安装docker-compose

    # 安装失败，就离谱，所以准备去下载官方安装包继续安装
    # yum -y install docker-compose
    # 上传官方包docker-compose-linux-x86_64
    # -----
    # 移动&修改包名
    mv docker-compose-linux-x86_64 /usr/local/bin/
    mv /usr/local/bin/docker-compose-linux-x86_64 /usr/local/bin/docker-compose
    # 增加可执行权限
    chmod +x /usr/local/bin/docker-compose
    # 检查是否安装成功
    docker-compose --version

使用docker-compose安装harbor

    $ mkdir /sypm/harbor_src
    $ mkdir /sypm/mount/harbor/data
    $ mkdir /sypm/mount/harbor/log
    $ cd /sypm/harbor_src
    $ wget https://storage.googleapis.com/harbor-releases/release-1.9.0/harbor-offline-installer-v1.9.4.tgz
    $ tar xvzf harbor-offline-installer-v1.9.4.tgz
    $ cd harbor
    $ vi harbor.yml
    # 修改服务器IP：hostname: 192.168.3.150 
    # 修改端口号为5000
    # 密码
    # db密码
    # 挂载的数据位置(一个是修改data位置/sypm/mount/harbor/data，一个是修改log位置/sypm/mount/harbor/log)
    $ ./install.sh

如果想要修改配置：

    $ cd /sypm/harbor_src/harbor
    $ docker-compose down -v
    $ vi harbor.yml
    $ docker-compose up -d

重启

    $ cd /sypm/harbor_src/harbor
    $ docker-compose stop
    $ docker-compose start

访问：

    http://192.168.3.150

尝试登录并推送一个简单的镜像

    docker login 192.168.3.150
    # 输入用户名密码报错提示连接被拒绝，可以配置docker的/etc/docker/daemon.json
    {
      "registry-mirrors": ["https://b9pmyelo.mirror.aliyuncs.com"],
      "insecure-registries": ["192.168.3.150"]
    }
    # 然后重启
    systemctl daemon-reload && systemctl restart docker
    # 再次login看看是否OK，如果OK我们推送一下这个bladex提供的镜像吧，正好改成sypm的tag就行
    docker pull bladex/alpine-java:openjdk8-openj9_cn_slim
    docker tag bladex/alpine-java:openjdk8-openj9_cn_slim 192.168.3.150/sypm-bladex/alpine-java:v1.0
    docker login 192.168.3.150
    docker push 192.168.3.150/sypm-bladex/alpine-java:v1.0
    # 注意push的前提是harbor服务器上已经有sypm-bladex这个项目了才可以（没有则去新建一个）a

### 5、Nacos

官方网站：https://github.com/nacos-group/nacos-docker

下载执行数据库脚本https://github.com/alibaba/nacos/blob/develop/distribution/conf/nacos-mysql.sql，初始化：

    /*
     * Copyright 1999-2018 Alibaba Group Holding Ltd.
     *
     * Licensed under the Apache License, Version 2.0 (the "License");
     * you may not use this file except in compliance with the License.
     * You may obtain a copy of the License at
     *
     *      http://www.apache.org/licenses/LICENSE-2.0
     *
     * Unless required by applicable law or agreed to in writing, software
     * distributed under the License is distributed on an "AS IS" BASIS,
     * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
     * See the License for the specific language governing permissions and
     * limitations under the License.
     */
     
     create database nacos_config;
     
     use nacos_config;
    
    /******************************************/
    /*   数据库全名 = nacos_config   */
    /*   表名称 = config_info   */
    /******************************************/
    CREATE TABLE `config_info` (
      `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT 'id',
      `data_id` varchar(255) NOT NULL COMMENT 'data_id',
      `group_id` varchar(255) DEFAULT NULL,
      `content` longtext NOT NULL COMMENT 'content',
      `md5` varchar(32) DEFAULT NULL COMMENT 'md5',
      `gmt_create` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
      `gmt_modified` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '修改时间',
      `src_user` text COMMENT 'source user',
      `src_ip` varchar(50) DEFAULT NULL COMMENT 'source ip',
      `app_name` varchar(128) DEFAULT NULL,
      `tenant_id` varchar(128) DEFAULT '' COMMENT '租户字段',
      `c_desc` varchar(256) DEFAULT NULL,
      `c_use` varchar(64) DEFAULT NULL,
      `effect` varchar(64) DEFAULT NULL,
      `type` varchar(64) DEFAULT NULL,
      `c_schema` text,
      `encrypted_data_key` text NOT NULL COMMENT '秘钥',
      PRIMARY KEY (`id`),
      UNIQUE KEY `uk_configinfo_datagrouptenant` (`data_id`,`group_id`,`tenant_id`)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT='config_info';
    
    /******************************************/
    /*   数据库全名 = nacos_config   */
    /*   表名称 = config_info_aggr   */
    /******************************************/
    CREATE TABLE `config_info_aggr` (
      `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT 'id',
      `data_id` varchar(255) NOT NULL COMMENT 'data_id',
      `group_id` varchar(255) NOT NULL COMMENT 'group_id',
      `datum_id` varchar(255) NOT NULL COMMENT 'datum_id',
      `content` longtext NOT NULL COMMENT '内容',
      `gmt_modified` datetime NOT NULL COMMENT '修改时间',
      `app_name` varchar(128) DEFAULT NULL,
      `tenant_id` varchar(128) DEFAULT '' COMMENT '租户字段',
      PRIMARY KEY (`id`),
      UNIQUE KEY `uk_configinfoaggr_datagrouptenantdatum` (`data_id`,`group_id`,`tenant_id`,`datum_id`)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT='增加租户字段';


​    
    /******************************************/
    /*   数据库全名 = nacos_config   */
    /*   表名称 = config_info_beta   */
    /******************************************/
    CREATE TABLE `config_info_beta` (
      `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT 'id',
      `data_id` varchar(255) NOT NULL COMMENT 'data_id',
      `group_id` varchar(128) NOT NULL COMMENT 'group_id',
      `app_name` varchar(128) DEFAULT NULL COMMENT 'app_name',
      `content` longtext NOT NULL COMMENT 'content',
      `beta_ips` varchar(1024) DEFAULT NULL COMMENT 'betaIps',
      `md5` varchar(32) DEFAULT NULL COMMENT 'md5',
      `gmt_create` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
      `gmt_modified` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '修改时间',
      `src_user` text COMMENT 'source user',
      `src_ip` varchar(50) DEFAULT NULL COMMENT 'source ip',
      `tenant_id` varchar(128) DEFAULT '' COMMENT '租户字段',
      `encrypted_data_key` text NOT NULL COMMENT '秘钥',
      PRIMARY KEY (`id`),
      UNIQUE KEY `uk_configinfobeta_datagrouptenant` (`data_id`,`group_id`,`tenant_id`)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT='config_info_beta';
    
    /******************************************/
    /*   数据库全名 = nacos_config   */
    /*   表名称 = config_info_tag   */
    /******************************************/
    CREATE TABLE `config_info_tag` (
      `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT 'id',
      `data_id` varchar(255) NOT NULL COMMENT 'data_id',
      `group_id` varchar(128) NOT NULL COMMENT 'group_id',
      `tenant_id` varchar(128) DEFAULT '' COMMENT 'tenant_id',
      `tag_id` varchar(128) NOT NULL COMMENT 'tag_id',
      `app_name` varchar(128) DEFAULT NULL COMMENT 'app_name',
      `content` longtext NOT NULL COMMENT 'content',
      `md5` varchar(32) DEFAULT NULL COMMENT 'md5',
      `gmt_create` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
      `gmt_modified` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '修改时间',
      `src_user` text COMMENT 'source user',
      `src_ip` varchar(50) DEFAULT NULL COMMENT 'source ip',
      PRIMARY KEY (`id`),
      UNIQUE KEY `uk_configinfotag_datagrouptenanttag` (`data_id`,`group_id`,`tenant_id`,`tag_id`)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT='config_info_tag';
    
    /******************************************/
    /*   数据库全名 = nacos_config   */
    /*   表名称 = config_tags_relation   */
    /******************************************/
    CREATE TABLE `config_tags_relation` (
      `id` bigint(20) NOT NULL COMMENT 'id',
      `tag_name` varchar(128) NOT NULL COMMENT 'tag_name',
      `tag_type` varchar(64) DEFAULT NULL COMMENT 'tag_type',
      `data_id` varchar(255) NOT NULL COMMENT 'data_id',
      `group_id` varchar(128) NOT NULL COMMENT 'group_id',
      `tenant_id` varchar(128) DEFAULT '' COMMENT 'tenant_id',
      `nid` bigint(20) NOT NULL AUTO_INCREMENT,
      PRIMARY KEY (`nid`),
      UNIQUE KEY `uk_configtagrelation_configidtag` (`id`,`tag_name`,`tag_type`),
      KEY `idx_tenant_id` (`tenant_id`)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT='config_tag_relation';
    
    /******************************************/
    /*   数据库全名 = nacos_config   */
    /*   表名称 = group_capacity   */
    /******************************************/
    CREATE TABLE `group_capacity` (
      `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT '主键ID',
      `group_id` varchar(128) NOT NULL DEFAULT '' COMMENT 'Group ID，空字符表示整个集群',
      `quota` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '配额，0表示使用默认值',
      `usage` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '使用量',
      `max_size` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '单个配置大小上限，单位为字节，0表示使用默认值',
      `max_aggr_count` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '聚合子配置最大个数，，0表示使用默认值',
      `max_aggr_size` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '单个聚合数据的子配置大小上限，单位为字节，0表示使用默认值',
      `max_history_count` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '最大变更历史数量',
      `gmt_create` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
      `gmt_modified` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '修改时间',
      PRIMARY KEY (`id`),
      UNIQUE KEY `uk_group_id` (`group_id`)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT='集群、各Group容量信息表';
    
    /******************************************/
    /*   数据库全名 = nacos_config   */
    /*   表名称 = his_config_info   */
    /******************************************/
    CREATE TABLE `his_config_info` (
      `id` bigint(20) unsigned NOT NULL,
      `nid` bigint(20) unsigned NOT NULL AUTO_INCREMENT,
      `data_id` varchar(255) NOT NULL,
      `group_id` varchar(128) NOT NULL,
      `app_name` varchar(128) DEFAULT NULL COMMENT 'app_name',
      `content` longtext NOT NULL,
      `md5` varchar(32) DEFAULT NULL,
      `gmt_create` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
      `gmt_modified` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
      `src_user` text,
      `src_ip` varchar(50) DEFAULT NULL,
      `op_type` char(10) DEFAULT NULL,
      `tenant_id` varchar(128) DEFAULT '' COMMENT '租户字段',
      `encrypted_data_key` text NOT NULL COMMENT '秘钥',
      PRIMARY KEY (`nid`),
      KEY `idx_gmt_create` (`gmt_create`),
      KEY `idx_gmt_modified` (`gmt_modified`),
      KEY `idx_did` (`data_id`)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT='多租户改造';


​    
    /******************************************/
    /*   数据库全名 = nacos_config   */
    /*   表名称 = tenant_capacity   */
    /******************************************/
    CREATE TABLE `tenant_capacity` (
      `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT '主键ID',
      `tenant_id` varchar(128) NOT NULL DEFAULT '' COMMENT 'Tenant ID',
      `quota` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '配额，0表示使用默认值',
      `usage` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '使用量',
      `max_size` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '单个配置大小上限，单位为字节，0表示使用默认值',
      `max_aggr_count` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '聚合子配置最大个数',
      `max_aggr_size` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '单个聚合数据的子配置大小上限，单位为字节，0表示使用默认值',
      `max_history_count` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '最大变更历史数量',
      `gmt_create` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
      `gmt_modified` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '修改时间',
      PRIMARY KEY (`id`),
      UNIQUE KEY `uk_tenant_id` (`tenant_id`)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT='租户容量信息表';


​    
    CREATE TABLE `tenant_info` (
      `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT 'id',
      `kp` varchar(128) NOT NULL COMMENT 'kp',
      `tenant_id` varchar(128) default '' COMMENT 'tenant_id',
      `tenant_name` varchar(128) default '' COMMENT 'tenant_name',
      `tenant_desc` varchar(256) DEFAULT NULL COMMENT 'tenant_desc',
      `create_source` varchar(32) DEFAULT NULL COMMENT 'create_source',
      `gmt_create` bigint(20) NOT NULL COMMENT '创建时间',
      `gmt_modified` bigint(20) NOT NULL COMMENT '修改时间',
      PRIMARY KEY (`id`),
      UNIQUE KEY `uk_tenant_info_kptenantid` (`kp`,`tenant_id`),
      KEY `idx_tenant_id` (`tenant_id`)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT='tenant_info';
    
    CREATE TABLE `users` (
    	`username` varchar(50) NOT NULL PRIMARY KEY,
    	`password` varchar(500) NOT NULL,
    	`enabled` boolean NOT NULL
    );
    
    CREATE TABLE `roles` (
    	`username` varchar(50) NOT NULL,
    	`role` varchar(50) NOT NULL,
    	UNIQUE INDEX `idx_user_role` (`username` ASC, `role` ASC) USING BTREE
    );
    
    CREATE TABLE `permissions` (
        `role` varchar(50) NOT NULL,
        `resource` varchar(255) NOT NULL,
        `action` varchar(8) NOT NULL,
        UNIQUE INDEX `uk_role_permission` (`role`,`resource`,`action`) USING BTREE
    );
    
    INSERT INTO users (username, password, enabled) VALUES ('nacos', '$2a$10$EuWPZHzz32dJN7jexM34MOeYirDdFAZm2kuWj7VEOJhhZkDrxfvUu', TRUE);
    
    INSERT INTO roles (username, role) VALUES ('nacos', 'ROLE_ADMIN');
    
    docker run -p 8848:8848 -p 9848:9848 -p 9555:9555 --name nacos-server --privileged=true --restart unless-stopped -v /sypm/mount/nacos/logs/:/home/nacos/logs -v /sypm/mount/nacos/init.d/custom.properties:/home/nacos/init.d/custom.properties -e MODE=standalone -e SPRING_DATASOURCE_PLATFORM=mysql -e MYSQL_SERVICE_HOST=192.168.3.150 -e MYSQL_SERVICE_DB_NAME=nacos_config -e MYSQL_SERVICE_PORT=3306 -e MYSQL_SERVICE_USER=root -e MYSQL_SERVICE_PASSWORD=Slv6mM6Slz6 -e MYSQL_SERVICE_DB_PARAM=characterEncoding=utf8\&connectTimeout=1000\&socketTimeout=3000\&autoReconnect=true\&useSSL=false -d  nacos/nacos-server:v2.1.0

然后访问，用户名：nacos，密码：nacos

    http://192.168.3.150:8848/nacos/#/login

最好在控制台再去修改一下nacos的密码

### 6、Sentinel（待更新）

如果想要使用docker启动，但是bladex提供的镜像无法修改用户名和密码，所以一版来说我们会自己构建一个镜像推送到镜像服务器

http://192.168.3.129/sypm-bladex-medicine/frame/sypm-docker-sentinel

    docker build -t 192.168.3.150/sypm-bladex/sentinel:v1.0 .
    docker login 192.168.3.150
    docker push 192.168.3.150/sypm-bladex/sentinel:v1.0

使用镜像启动服务

    docker run --name sentinel -p 8888:8888 -p 8858:8858 -d 192.168.3.150/sypm-bladex/sentinel:v1.0 -Dserver.port=8858 -Dcsp.sentinel.api.port=8888 -Djava.security.egd=file:/dev/./urandom -Dcsp.sentinel.dashboard.server=localhost:8858 -Dsentinel.dashboard.auth.username=admin -Dsentinel.dashboard.auth.password=XXXXX -Dproject.name=sentinel-dashboard ./sentinel-dashboard-1.8.4.jar

访问，用户名admin，密码XXXXX

    http://192.168.3.150:8858

### 7、Jenkins

docker启动安装

    docker run --name jenkins -d -u root -p 8080:8080 --privileged=true -v /sypm/mount/jenkins_blueocean:/var/jenkins_home -v /var/run/docker.sock:/var/run/docker.sock jenkinsci/blueocean:1.25.5

启动过程中有提示登录密码

    *************************************************************
    *************************************************************
    *************************************************************
    
    Jenkins initial setup is required. An admin user has been created and a password generated.
    Please use the following password to proceed to installation:
    
    ed98ddcef5e64d08a2ea00b900b37159
    
    This may also be found at: /var/jenkins_home/secrets/initialAdminPassword
    
    *************************************************************
    *************************************************************
    *************************************************************

## 三、bladex框架组件

### 1、数据同步

#### DB

首先，我们先将db数据库表数据进行同步

两个库（utf8mb4 utf8mb4_0900_ai\_ci）：

*   sypm-blade（来自于我们dump的数据文件夹）
    
*   sypm-blade-flow（来自于原始的sql脚本）
    

#### oss数据

*   创建一个桶（bucket）：sypm-bladex-bucket
    

#### nacos配置

##### blade.yaml

    #服务器配置
    server:
      undertow:
        threads:
          # 设置IO线程数, 它主要执行非阻塞的任务,它们会负责多个连接, 默认设置每个CPU核心一个线程
          io: 16
          # 阻塞任务线程池, 当执行类似servlet请求阻塞操作, undertow会从这个线程池中取得线程,它的值设置取决于系统的负载
          worker: 400
        # 以下的配置会影响buffer,这些buffer会用于服务器连接的IO操作,有点类似netty的池化内存管理
        buffer-size: 1024
        # 是否分配的直接内存
        direct-buffers: true
    
    #spring配置
    spring:
      cloud:
        sentinel:
          eager: true
      devtools:
        restart:
          log-condition-evaluation-delta: false
        livereload:
          port: 23333
    
    #feign配置
    feign:
      sentinel:
        enabled: true
      okhttp:
        enabled: true
      httpclient:
        enabled: false
    
    #hystrix配置
    hystrix:
      threadpool:
        default:
          coreSize: 300
          maxQueueSize: 1000
          queueSizeRejectionThreshold: 800
      command:
        default:
          execution:
            isolation:
              thread:
                timeoutInMilliseconds: 5000
    
    #ribbon配置
    ribbon:
      #对当前实例的重试次数
      MaxAutoRetries: 1
      #切换实例的重试次数
      MaxAutoRetriesNextServer: 2
      #请求处理的超时时间
      ReadTimeout: 60000
      #请求连接的超时时间
      ConnectTimeout: 60000
      #对所有操作请求都进行重试
      OkToRetryOnAllOperations: true
    
    #对外暴露端口
    management:
      endpoints:
        web:
          exposure:
            include: "*"
      endpoint:
        health:
          show-details: always
    
    #knife4j配置
    knife4j:
      #启用
      enable: true
      #基础认证
      basic:
        enable: false
        username: blade
        password: blade
      #增强配置
      setting:
        enableSwaggerModels: true
        enableDocumentManage: true
        enableHost: false
        enableHostText: http://localhost
        enableRequestCache: true
        enableFilterMultipartApis: false
        enableFilterMultipartApiMethodType: POST
        language: zh-CN
        enableFooter: false
        enableFooterCustom: true
        footerCustomContent: Copyright © 2021 BladeX All Rights Reserved
    
    #swagger公共信息
    swagger:
      title: BladeX 接口文档系统
      description: BladeX 接口文档系统
      version: 2.9.1.RELEASE
      license: Powered By BladeX
      license-url: https://bladex.vip
      terms-of-service-url: https://bladex.vip
      contact:
        name: smallchill
        email: smallchill@163.com
        url: https://gitee.com/smallc
    
    #blade配置
    blade:
      #token配置
      token:
        #是否有状态
        state: false
      #redis序列化方式
      redis:
        serializer-type: protostuff
      #接口配置
      api:
        #报文加密配置
        crypto:
          #启用报文加密配置
          enabled: false
          #使用AesUtil.genAesKey()生成
          aes-key: O2BEeIv399qHQNhD6aGW8R8DEj4bqHXm
          #使用DesUtil.genDesKey()生成
          des-key: jMVCBsFGDQr1USHo
      #jackson配置
      jackson:
        #null自动转空值
        null-to-empty: true
        #大数字自动转字符串
        big-num-to-string: true
        #支持text文本请求,与报文加密同时开启
        support-text-plain: false
      #xss配置
      xss:
        enabled: true
        skip-url:
          - /weixin
          - /notice/submit
          - /model/submit
      #安全框架配置
      secure:
        #接口放行
        skip-url:
          - /test/**
        #授权认证配置
        auth:
          - method: ALL
            pattern: /weixin/**
            expression: "hasAuth()"
          - method: POST
            pattern: /dashboard/upload
            expression: "hasTimeAuth(9, 17)"
          - method: POST
            pattern: /dashboard/submit
            expression: "hasAnyRole('administrator', 'admin', 'user')"
        #基础认证配置
        basic:
          - method: ALL
            pattern: /dashboard/info
            username: "blade"
            password: "blade"
        #动态签名认证配置
        sign:
          - method: ALL
            pattern: /dashboard/sign
            crypto: "sha1"
        #多终端认证配置
        client:
          - client-id: sword
            path-patterns:
              - /sword/**
          - client-id: saber
            path-patterns:
              - /saber/**
      #多租户配置
      tenant:
        #多租户增强
        enhance: true
        #多租户授权保护
        license: false
        #动态数据源功能
        dynamic-datasource: false
        #动态数据源全局扫描
        dynamic-global: false
        #多租户字段名
        column: tenant_id
        #排除多租户逻辑
        exclude-tables:
          - blade_user

##### blade-test.yaml

    #spring配置
    spring:
      redis:
        ##redis 单机环境配置
        host: 192.168.3.150
        port: 6379
        password: 62eyikD4L55Wa
        database: 0
        ssl: false
        ##redis 集群环境配置
        #cluster:
        #  nodes: 127.0.0.1:7001,127.0.0.1:7002,127.0.0.1:7003
        #  commandTimeout: 5000
      datasource:
        driver-class-name: com.mysql.cj.jdbc.Driver
        #driver-class-name: org.postgresql.Driver
        #driver-class-name: oracle.jdbc.OracleDriver
        #driver-class-name: com.microsoft.sqlserver.jdbc.SQLServerDriver
        #driver-class-name: dm.jdbc.driver.DmDriver
        druid:
          # MySql、PostgreSQL、SqlServer、DaMeng校验
          validation-query: select 1
          # Oracle校验
          #validation-query: select 1 from dual
    
    #项目模块集中配置
    blade:
      #分布式锁配置
      lock:
        enabled: false
        address: redis://192.168.3.150:6379
      #多团队协作服务配置
      ribbon:
        rule:
          #开启配置
          enabled: true
          #负载均衡优先调用的ip段
          prior-ip-pattern:
            - 192.168.0.*
            - 127.0.0.1
      #通用开发生产环境数据库地址(特殊情况可在对应的子工程里配置覆盖)
      datasource:
        test:
          # MySql
          url: jdbc:mysql://192.168.3.150:3306/sypm-blade?useSSL=false&useUnicode=true&characterEncoding=utf-8&zeroDateTimeBehavior=convertToNull&transformedBitIsBoolean=true&tinyInt1isBit=false&allowMultiQueries=true&serverTimezone=GMT%2B8&allowPublicKeyRetrieval=true
          username: root
          password: Slv6mM6Slz6
          # PostgreSQL
          #url: jdbc:postgresql://127.0.0.1:5432/bladex
          #username: postgres
          #password: 123456
          # Oracle
          #url: jdbc:oracle:thin:@127.0.0.1:1521:orcl
          #username: BLADEX
          #password: BLADEX
          # SqlServer
          #url: jdbc:sqlserver://127.0.0.1:1433;DatabaseName=bladex
          #username: bladex
          #password: bladex
          # DaMeng
          #url: jdbc:dm://127.0.0.1:5236/BLADEX?zeroDateTimeBehavior=convertToNull&useUnicode=true&characterEncoding=utf-8
          #username: BLADEX
          #password: BLADEX
    #钉钉登录配置
    dingtalk:
      enabled: true
      appKey: ding4ftx2ydxakeprgio
      appSecret: tH0obhsiW08NqwlnagUuw0NkConorKriHp4ubZtYoz7IInEv_PtJ-FIUpfEU59t9
      agentId: 1536869080
      spaceid: 7777496713
    
    #oss配置
    oss:
      enabled: true
      name: minio
      tenant-mode: false
      endpoint: http://192.168.3.150:9000
      access-key: admin
      secret-key: mdOcwqwF125SKe
      bucket-name: sypm-bladex-bucket
    
    wechat:
      miniapp:
        meeting:
          appid: wxe70d012e8ca64b2c
          secret: 09b52e11a5361c8649c2f6dcdda55526
          path: pages/login/login
          qrcode_width: 1000
          version: release
          color: 0,0,0
          auto_color: true
          is_hyaline: true
        cnmedicine:
          appid: wx3220cfb7fb532bca
          secret: 8d2bbfb865af804c542c3b71ab01b57a
        test:
          appid: wx1c354930e09d631d
          secret: 91c21cb4ad828b030357b20fc24f43e3

### 2、部署组件项目

#### Jenkins配置

k8s主节点执行如下命令：

    kubectl create secret docker-registry sypm-harbor-secret --docker-server=192.168.3.150 --docker-username=app --docker-password=XXXXX --docker-email=primexpy@163.com

可以在rancher直接Import该yaml配置：

    apiVersion: v1
    kind: ServiceAccount
    metadata:
      name: sypm-sa
      namespace: default
    imagePullSecrets:
      - name: sypm-harbor-secret

然后我们的deployment的模板需要使用该sa

    deployment:
    	spec:
    		template:
    			spec:
    				serviceAccountName: sypm-sa

安装插件：

    docker相关，k8s相关，宁可多安一堆不要少安一个
    Role-based Authorization Strategy插件，用于权限控制（先使用jenkins自带功能manage users添加用户）然后再manage and assign roles去manage roles添加一个developer这种角色并给角色需要的功能打钩，之后再Assign Roles，添加用户与角色的绑定。

#### 新建流水线项目

pipeline选项中选择pipeline script from scm，然后配置git项目地址、鉴权信息、分支信息

#### 如何发布

进入sypm-bladex，点击run，选择相应的应用以及环境（目前只有test），点击运行即可

### 3、网关服务

先部署一个service

    apiVersion: v1
    kind: Service
    metadata:
      name: blade-gateway-svc
    spec:
      type: NodePort
      ports:
      - port: 80
        targetPort: 81
        nodePort: 30888
      selector:
        app: blade-gateway

然后可以访问节点放开的入口，比如先获取token试一试

    curl --location --request POST 'http://192.168.3.151:30888/blade-auth/oauth/token' \
    --header 'Authorization: Basic c2FiZXI6c2FiZXJfc2VjcmV0' \
    --header 'Tenant-Id: 000000' \
    --header 'Content-Type: application/x-www-form-urlencoded' \
    --data-urlencode 'username=admin' \
    --data-urlencode 'password=e10adc3949ba59abbe56e057f20f883e' \
    --data-urlencode 'scope=all' \
    --data-urlencode 'grant_type=password'

至此，基础的核心框架组件应用已经部署了

### 4、nginx

    # 下载镜像
    docker pull nginx:1.23.0
    
    # 最好使用我们提供给容器配置，一般来说可以从官方网站下载，或者使用先启动容器再copy配置到宿主机的方式：
    docker run -u root --privileged=true --name nginx-app -p 1888:80 -p 1443:443 -d nginx:1.23.0
    docker cp nginx-app:/etc/nginx /sypm/mount/nginx/conf
    docker cp nginx-app:/usr/share/nginx/html /sypm/mount/nginx/html
    docker stop nginx-app
    docker rm nginx-app
    mkdir /sypm/mount/nginx/log
    
    # 然后再启动的时候可以使用该配置文件启动
    docker run -u root --privileged=true --name nginx-app -p 1166:66 -p 1177:77 -p 1443:443 -v /sypm/mount/nginx/log:/var/log/nginx -v /sypm/mount/nginx/conf:/etc/nginx -v /sypm/mount/nginx/html:/usr/share/nginx/html -d nginx:1.23.0

访问：http://192.168.3.150:1166

我们需要修改配置 /sypm/mount/nginx/conf/conf.d/default.conf

    server {
      listen       66;
      server_name  gateway;
      location / {
           proxy_set_header Host $host;
           proxy_set_header X-Real-IP $remote_addr;
           proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
           proxy_buffering off;
           proxy_pass http://gateway;
      }
      if ($request_uri ~ "/actuator") {
          return 403;
      }
    }
    #server {
    #  listen       77;
    #  server_name  web;
    #  root         /usr/share/nginx/html;
    #  location / {
    #       root   /usr/share/nginx/html;
    #       index  index.html index.htm;
    #  }
    #  location ^~ /api {
    #       proxy_set_header Host $host;
    #       proxy_set_header X-Real-IP $remote_addr;
    #       proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    #       proxy_buffering off;
    #       rewrite ^/api/(.*)$ /$1 break;
    #       proxy_pass http://gateway;
    #  }
    }
    upstream gateway {
      server 192.168.3.151:30888;
      server 192.168.3.149:30888;
    }

接下来我们试试访问192.168.3.150:1166相关

    # 得到403
    http://192.168.3.150:1166/actuator
    
    # 获取token
    curl --location --request POST 'http://192.168.3.150:1166/blade-auth/oauth/token' \
    --header 'Authorization: Basic c2FiZXI6c2FiZXJfc2VjcmV0' \
    --header 'Tenant-Id: 000000' \
    --header 'Content-Type: application/x-www-form-urlencoded' \
    --data-urlencode 'username=admin' \
    --data-urlencode 'password=e10adc3949ba59abbe56e057f20f883e' \
    --data-urlencode 'scope=all' \
    --data-urlencode 'grant_type=password'

## 四、gitlab业务模块CICD

### 1、节点配置runner

打开你的项目 ——> setting ——> runners ——> 找到注册配置

    # docker run -d --name gitlab-runner --privileged=true -u root --restart always -v /root/.m2:/root/.m2 -v /sypm/mount/gitlab_ranner/.kube_test:/root/.kube -v /sypm/mount/gitlab_ranner/config:/etc/gitlab-runner -v /var/run/docker.sock:/var/run/docker.sock gitlab/gitlab-runner:v15.1.1
    
    # docker exec -it gitlab-runner /bin/bash
    
    # gitlab-ci-multi-runner register
    # http://192.168.3.129/
    # GR1348941USV9eQgEWe6wj-sBYzPy
    # node03
    # k8s
    # xxx
    # docker
    # docker:20.10.17
    
    # ---注册可以成功但是启动失败---
    # docker run -it --name gitlab-runner -v /sypm/mount/gitlab_ranner/.kube_test:/root/.kube -v /sypm/mount/gitlab_ranner/config:/etc/gitlab-runner -v /var/run/docker.sock:/var/run/docker.sock gitlab/gitlab-runner:v15.1.1 register --non-interactive --executor "docker" --docker-image docker:20.10.17 --url "http://192.168.3.129/" --registration-token "GR1348941USV9eQgEWe6wj-sBYzPy" --description "sypm-bladex-medicine-biz" --tag-list "k8s" --run-untagged="true" --locked="false" --access-level="not_protected"
    
    # Download the binary for your system
    sudo curl -L --output /usr/local/bin/gitlab-runner https://gitlab-runner-downloads.s3.amazonaws.com/latest/binaries/gitlab-runner-linux-amd64
    
    # Give it permission to execute
    sudo chmod +x /usr/local/bin/gitlab-runner
    
    # Create a GitLab Runner user
    sudo useradd --comment 'GitLab Runner' --create-home gitlab-runner --shell /bin/bash
    
    # Install and run as a service
    gitlab-runner install --user=gitlab-runner --working-directory=/sypm/gitlab-runner
    
    gitlab-runner start
    
    gitlab-runner register --url http://192.168.3.129/ --registration-token GR1348941USV9eQgEWe6wj-sBYzPy
    
    # gitlab-ci-multi-runner register
    # http://192.168.3.129/
    # GR1348941USV9eQgEWe6wj-sBYzPy
    # node03
    # k8s
    # xxx
    # docker
    # docker:20.10.17

在runner所在的node节点上修改vim /etc/gitlab-runner/config.toml配置（主要是挂载docker管道，maven配置，kubectl配置，以及我们的deployment.yaml模板注意该模板别忘了放在宿主机的/sypm/mount/gitlab-runner/deployment.yaml位置，原文件我放在了git管理中http://192.168.3.129/sypm-bladex-medicine/frame/sypm-bladex-cicd.git）（该git项目中的gitlab-ci-java.yaml文件由biz项目的.gitlab-ci.yaml文件做了一个include引用）

    concurrent = 1
    check_interval = 0
    
    [session_server]
      session_timeout = 1800
    
    [[runners]]
      name = "node03"
      url = "http://192.168.3.129/"
      token = "AyxZnXGm61mRyRyKv9MS"
      executor = "docker"
      [runners.custom_build_dir]
      [runners.cache]
        [runners.cache.s3]
        [runners.cache.gcs]
        [runners.cache.azure]
      [runners.docker]
        tls_verify = false
        image = "docker:20.10.17"
        privileged = false
        disable_entrypoint_overwrite = false
        oom_kill_disable = false
        disable_cache = false
        volumes = ["/cache","/root/.m2:/root/.m2","/var/run/docker.sock:/var/run/docker.sock","/sypm/mount/gitlab-runner/deployment.yaml:/deployment.yaml","/root/.kube/config:/root/.kube/config"]
        shm_size = 0

### 2、业务模块项目配置

使用.gitlab-ci.yaml文件（会被gitlab自动扫描到）

.gitlab-ci.yml中配置了很多变量以及其Include了另一个项目的一个片段

    include:
      project: sypm-bladex-medicine/frame/sypm-bladex-cicd
      ref: main
      file: gitlab-ci-java.yml

gitlab-ci-java.yml中则是流水线步骤，然后里面用到了宿主机上的maven配置，docker的socket，以及还有一个./deployment.yaml模板文件（也放到了宿主机上），kubectl配置用来连接集群